<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Deploying</title>
		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
<link rel="stylesheet" href="dist/theme/white.css" id="theme">
		<!-- Theme used for syntax highlighted code -->
<link rel="stylesheet" href="plugin/highlight/github.css" id="highlight-theme"></head>
	<body>
		<div class="reveal">
			<div class="slides">
<section data-markdown  ><textarea data-template>
[comment]: # "markdown: { smartypants: true }"

### Deploying

# Node.js

#### in 2022

<small>a (very simple) beginner's guide</small>

</textarea></section>
<section data-markdown  ><textarea data-template>

# ðŸ¤ 

</textarea></section>
<section data-markdown  ><textarea data-template>

https://beyondcodebootcamp.github.io/presos/deploying-nodejs-in-2022/

</textarea></section>
<section data-markdown  ><textarea data-template>

-   Caddy: https://webinstall.dev/caddy
-   DuckDNS: https://duckdns.org
-   Digital Ocean: https://m.do.co/c/ad3b82be23f6
-   Express Starter: https://github.com/BeyondCodeBootcamp/node-express-starter/
-   Name.com: https://www.name.com/referral/13d0ac
-   Node: https://webinstall.dev/node
-   Serviceman: https://webinstall.dev/serviceman
-   Webi: https://webinstall.dev/

</textarea></section>
<section data-markdown  ><textarea data-template>

![](https://coolaj86.com/assets/media/coolaj86-2017.jpg)

AJ ONeal <br> [@\_beyondcode](https://twitter.com/@_beyondcode) <br>
[twitch.tv/coolaj86](https://twitch.tv/coolaj86)

</textarea></section>
<section data-markdown  ><textarea data-template>

Technophobic Technologist

Dangerous Wrong Thinker

Equal Opportunity Offender

</textarea></section>
<section data-markdown  ><textarea data-template>

<img title="node.js: official logo" src="https://nodejs.org/static/images/logos/nodejs-new-pantone-black.svg" width="60%" />

https://nodejs.org/en/about/resources/

</textarea></section>
<section data-markdown  ><textarea data-template>

## Overview

1.  Public Key (for Login)
2.  Server (VPS)
3.  DNS (Domain Name)
4.  App "User"
5.  Launcher (systemd)

</textarea></section>
<section data-markdown  ><textarea data-template>

... and YOUR PROJECT

<small>(duh!)</small>

(Node.js + Git)

</textarea></section>
<section data-markdown  ><textarea data-template>

## Bonus Material

<small>(there will be some bonus material)</small>

</textarea></section>
<section data-markdown  ><textarea data-template>

## 1. Public Key

(secure)

</textarea></section>
<section data-markdown  ><textarea data-template>

## SSH Public Key

<a href="https://webinstall.dev/ssh-pubkey">webinstall.dev/ssh-pubkey</a>

<small>(ssh-keygen)</small>

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
curl -f https://webinstall.dev/ssh-pubkey | bash
```

</textarea></section>
<section data-markdown  ><textarea data-template>

```txt
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDC6aziziaVOvXTaHd5t+ez6vtQBIBbsHmZW/aEZgiaFxQ/IcdusfPqzyCCC7c6lhck2xDYgtg6mF4ASZ5rg0n7YvVlI70ULQE/aMp9n/p/Nb1p7qDpJLpjblFOR/p9Ewr/SI9yo44N5ElFKMvICG1LVI1uO9KEfAKs2gazRXqO6cGt0jwLwmyHdBLho8wRj89pHCXINKJ3K8SdfCCVJ/csG1IIk7Vlf+CvOInkGY2hCU1iCsUVL5fqG3+5nnaTRJQUBR2npGYJ0M4d1UjpQSKrkQyDheCJDltu4y2jpyH13y9CEW8GtIJOF4iIu+eScEdpLL6nJ8cV+Nui9vBSV+Wp app@beta.rootprojects.org
```

</textarea></section>
<section data-markdown  ><textarea data-template>

```txt
# My First Public Key
ssh-rsa <base64-encoded-public-key> <email-like-comment>
```

</textarea></section>
<section data-markdown  ><textarea data-template>

## [Digital Ocean](https://m.do.co/c/ad3b82be23f6)

<small><a href="https://m.do.co/c/ad3b82be23f6">$100 / 60 days free</a></small>

| $5/month | 1 vCPU / 1GB / 20GB     |
| -------- | ----------------------- |
| $1/month | Backups                 |
| $0       | 100% Uptime w/ Failover |
| $0       | IPv6 + Monitoring       |
| $0       | Secure SSH Login        |

</textarea></section>
<section data-markdown  ><textarea data-template>

### Other VPSes

-   Vultr
-   OVH
-   Scaleway

</textarea></section>
<section data-markdown  ><textarea data-template>

## Domain Services

| Name.com | .com, etc    | <a href="https://www.name.com/referral/13d0ac">affiliate link</a> |
| -------- | ------------ | ----------------------------------------------------------------- |
| DuckDNS  | .duckdns.org | <a href="https://duckdns.org">duckdns.org</a>                     |

</textarea></section>
<section data-markdown  ><textarea data-template>

## DNS Setup

-   A
-   AAAA

</textarea></section>
<section data-markdown  ><textarea data-template>

## User Setup

Create the `app` user with your Public Key.

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
ssh root@YOUR-PROJECT.duckdns.org \
    'curl https://webinstall.dev/ssh-adduser | bash'
```

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
ssh app@YOUR-PROJECT.duckdns.org
```

</textarea></section>
<section data-markdown  ><textarea data-template>

## Project Setup

-   git
-   node
-   YOUR-PROJECT

</textarea></section>
<section data-markdown  ><textarea data-template>

### Git Setup

</textarea></section>
<section data-markdown  ><textarea data-template>

Person Access Token: https://github.com/settings/tokens

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
export TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

```bash
git --version || sudo apt install -y git
```

```bash
git config --global url."https://api:$TOKEN@github.com/".insteadOf "https://github.com/"
git config --global url."https://ssh:$TOKEN@github.com/".insteadOf "ssh://git@github.com/"
git config --global url."https://git:$TOKEN@github.com/".insteadOf "git@github.com:"
```

<small>(todo: git-credentials)</small>

</textarea></section>
<section data-markdown  ><textarea data-template>

### Clone Project

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
git clone ssh://git@github.com:YOUR-ORG/YOUR-PROJECT.git
pushd ./YOUR-PROJECT/
```

</textarea></section>
<section data-markdown  ><textarea data-template>

### Project Config

```bash
npm ci --only=production
```

</textarea></section>
<section data-markdown  ><textarea data-template>

### Full-Blown IDE

```bash
webi vim-essentials
```

<small>(todo: vim-utf8)</small>

</textarea></section>
<section data-markdown  ><textarea data-template>

### Project ENVs

```bash
rsync -avhP ./example.env ./.env
vim ./.env
```

<small><a href="https://12factor.net/">12factor.net</a></small>

</textarea></section>
<section data-markdown  ><textarea data-template>

## Launcher

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
npm start
```

</textarea></section>
<section data-markdown  ><textarea data-template>

### serviceman

<small>(systemd on Linux)</small>

```bash
sudo env PATH="${PATH}" \
    serviceman add --username "$(whoami)" \
        --cap-net-bind -- \
    npm start
```

<small>(todo: add-service)</small>

</textarea></section>
<section data-markdown  ><textarea data-template>

## Bonus Material

</textarea></section>
<section data-markdown  ><textarea data-template>

## Just the Basics

</textarea></section>
<section data-markdown  ><textarea data-template>

(avoid useless abstractions, learn useful skills)

</textarea></section>
<section data-markdown  ><textarea data-template>

(2mb of JS for [6 lines of git](https://therootcompany.com/blog/how-github-does-smarter-shallow-clones/))

</textarea></section>
<section data-markdown  ><textarea data-template>

"Linux"

vs

"Deploy Node.js App"

</textarea></section>
<section data-markdown  ><textarea data-template>

"Web Security"

vs

"Deploy Node.js App"

</textarea></section>
<section data-markdown  ><textarea data-template>

"High-Availability Kubernetes Cluster Containerization"

vs

"Deploy Node.js App"

</textarea></section>
<section data-markdown  ><textarea data-template>

"Black Box"

vs

"Deploy Node.js App"

</textarea></section>
<section data-markdown  ><textarea data-template>

## npm start

```txt
package.js.main
```

```bash
server.js
app.js
```

```bash
NODE_ENV=development
PORT=3000
```

</textarea></section>
<section data-markdown  ><textarea data-template>

## Caddy

```bash
webi caddy
```

```bash
mkdir -p ~/srv/
touch ~/srv/Caddyfile
```

</textarea></section>
<section data-markdown  ><textarea data-template>

Caddyfile QuickStart

<a href="https://webinstall.dev/caddy">https://webinstall.dev/caddy</a>

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
sudo env PATH="${PATH}" \
    serviceman add --username "$(whoami)" \
        --name caddy --cap-net-bind -- \
    caddy run --config ./srv/Caddyfile
```

</textarea></section>
<section data-markdown  ><textarea data-template>

## Logs

</textarea></section>
<section data-markdown  ><textarea data-template>

Enable `journalctl`:

```bash
sudo systemctl enable systemd-journald
sudo systemctl restart systemd-journald
```

</textarea></section>
<section data-markdown  ><textarea data-template>

If that didn't work:

```bash
sudo mkdir -p /var/log/journal
sudo chown -R root:systemd-journal /var/log/journal/
sudo sed -i 's/#\?Storage=.*/Storage=persistent/' /etc/systemd/journald.conf

sudo systemctl restart systemd-journald
```

https://gist.github.com/JPvRiel/b7c185833da32631fa6ce65b40836887

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
sudo systemctl restart YOUR-PROJECT
sudo journalctl -xefu YOUR-PROJECT
```

</textarea></section>
<section data-markdown  ><textarea data-template>

## SSH Config

</textarea></section>
<section data-markdown  ><textarea data-template>

```ssh
Host YOUR-PROJECT
    Hostname YOUR-PROJECT.duckdns.org

Host *
    User app
```

</textarea></section>
<section data-markdown  ><textarea data-template>

## Save ðŸ’° w/ Swap Space

<a href="https://webinstall.dev/vps-addswap">https://webinstall.dev/vps-addswap</a>

</textarea></section>
<section data-markdown  ><textarea data-template>

```bash
export NODE_OPTIONS="--max-old-space-size=4096"
```

```bash
sudo fallocate -l 4G /var/swapfile
sudo chmod 0600 /var/swapfile
sudo mkswap /var/swapfile
```

</textarea></section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/math/math.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
Reveal.initialize({
controls : false,
markdown : {smartypants: true},
controls : false,
keyboard : true,
hash : false,
respondToHashChanges : false,
				hash: true,
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealMath ]
			});
		</script>
	</body>
</html>
